#!/Users/calebfaruki/study/enkodo/.venv/bin/python3
"""
Usage:
    enkodo analyze <filename>
    enkodo band <filename>
    enkodo deband <filename>
    enkodo interlace <filename>
    enkodo deinterlace <filename>
    enkodo block <filename>
    enkodo deblock <filename>
"""

import sys
import os
import subprocess
from docopt import docopt
import vapoursynth as vs

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from enkodo.analyze import analyze
from enkodo.filters.deband import deband
from enkodo.filters.deinterlace import deinterlace
from enkodo.filters.deblock import deblock
import enkodo.utils as utils

core = vs.core

def main():
    arguments = docopt(__doc__)

    if arguments['analyze']:
        analysis = analyze(arguments)
        print(analysis)
    elif arguments["band"]:
        band(arguments)
    elif arguments["deband"]:
        deband(arguments)
    elif arguments["interlace"]:
        interlace(arguments)
    elif arguments["deinterlace"]:
        deinterlace(arguments)
    elif arguments["block"]:
        block(arguments)
    elif arguments["deblock"]:
        deblock(arguments)

def band(arguments):
    filename = arguments["<filename>"]
    analysis = analyze(arguments)

    clip = utils.load_clip(filename)

    # Calculate divisor based on bit depth
    target_levels = 32
    current_levels = 2 ** analysis.bit_depth
    divisor = current_levels // target_levels

    clip = core.std.Lut(clip, function=lambda x: (x // divisor) * divisor)

    utils.pipe_to_ffmpeg(clip, "examples/banding/banded.mp4", crf=26)

def interlace(arguments):
    print("Interlacing...")
    filename = arguments["<filename>"]
    
    command = f"""
        ffmpeg -y -i {filename} -vf "tinterlace=mode=interleave_top" -c:v libx264 -crf 12 examples/interlacing/interlaced.mp4
    """
    subprocess.run(command, shell=True)

def block(arguments):
    print("Blocking...")
    filename = arguments["<filename>"]

    # Throttle bitrate and disable built-in h.264 deblocking
    command = f"""
        ffmpeg -y -i {filename} -c:v libx264 -b:v 800k -x264-params no-deblock=1 -preset ultrafast examples/blocking/blocked.mp4
    """

    subprocess.run(command, shell=True)

if __name__ == "__main__":
    main()